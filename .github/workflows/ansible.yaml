---
name: Configure Infrastructure

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]
    paths:
      - "infrastructure/**"
      - "!infrastructure/**/*.md"
  push:
    branches: ["main"]
    paths:
      - "infrastructure/**"
      - "!infrastructure/**/*.md"

jobs:
  # Job 1: Dry Run (Runs on PRs and Main)
  check:
    name: Ansible Check (Dry Run)
    runs-on: home-ops-runner
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.14" # Pin to stable 3.11
          cache: "pip" # Optional: caches pip dependencies
          cache-dependency-path: infrastructure/requirements.txt
      - name: Install Requirements
        run: pip install -r infrastructure/requirements.txt
      - name: Install Ansible Galaxy Roles
        run: ansible-galaxy install -r infrastructure/requirements.yaml
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Run Ansible Playbook (Check Mode)
        working-directory: infrastructure
        run: |
          ansible-playbook -i inventory/hosts.yaml playbook.yaml --check --diff -e 'ansible_python_interpreter=/usr/bin/python3'

  # Job 2: Apply (Runs ONLY on push to main, after Check passes)
  apply:
    name: Ansible Apply
    needs: check
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
    runs-on: home-ops-runner
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: "3.14" # Pin to stable 3.11
          cache: "pip" # Optional: caches pip dependencies
          cache-dependency-path: infrastructure/requirements.txt
      - name: Install Requirements
        run: pip install -r infrastructure/requirements.txt
      - name: Install Galaxy Roles
        run: ansible-galaxy install -r infrastructure/requirements.yaml
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Run Ansible Playbook (Apply)
        working-directory: infrastructure
        run: |
          ansible-playbook -i inventory/hosts.yaml playbook.yaml -e 'ansible_python_interpreter=/usr/bin/python3'
