---
name: Configure Infrastructure

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]
    paths:
      - "infrastructure/**"
      - "!infrastructure/**/*.md"
  push:
    branches: ["main"]
    paths:
      - "infrastructure/**"
      - "!infrastructure/**/*.md"

jobs:
  # Job 1: Dry Run (Runs on PRs and Main)
  check:
    name: Ansible Check (Dry Run)
    runs-on: home-ops-runner
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: "3.11" # Pin to stable 3.11
          cache: "pip" # Optional: caches pip dependencies
          cache-dependency-path: infrastructure/requirements.txt
      - name: Install Requirements
        run: pip install -r infrastructure/requirements.txt
      - name: Install Ansible Galaxy Roles
        run: ansible-galaxy install -r infrastructure/requirements.yaml
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Run Ansible Playbook (Check Mode)
        working-directory: infrastructure
        run: |
          ansible-playbook -i inventory/hosts.yaml playbook.yaml --check --diff -e 'ansible_python_interpreter=/usr/bin/python3'

  # Job 2: Apply (Runs ONLY on push to main, after Check passes)
  apply:
    name: Ansible Apply
    needs: check
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
    runs-on: home-ops-runner
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: "3.11" # Pin to stable 3.11
          cache: "pip" # Optional: caches pip dependencies
          cache-dependency-path: infrastructure/requirements.txt
      - name: Install Requirements
        run: pip install -r infrastructure/requirements.txt
      - name: Install Galaxy Roles
        run: ansible-galaxy install -r infrastructure/requirements.yaml
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
      - name: Run Ansible Playbook (Apply)
        working-directory: infrastructure
        run: |
          ansible-playbook -i inventory/hosts.yaml playbook.yaml -e 'ansible_python_interpreter=/usr/bin/python3'
