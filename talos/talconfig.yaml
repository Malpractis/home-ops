---
clusterName: matalos

talosVersion: "${talosVersion}"
kubernetesVersion: "${kubernetesVersion}"

endpoint: https://192.168.10.20:6443
additionalApiServerCertSans: &sans
  - "127.0.0.1"
  - "192.168.10.20"
  - "matalos.materia.k8s"
  - "matalos.internal"
additionalMachineCertSans: *sans

clusterPodNets: ["10.42.0.0/16"]
clusterSvcNets: ["10.43.0.0/16"]

# Disable built-in CNI to use Cilium
cniConfig:
  name: none

nodes:
  - hostname: "matalos-c1"
    ipAddress: "192.168.20.10"
    installDiskSelector:
      model: "QEMU HARDDISK"
    machineSpec:
      secureboot: false
    talosImageURL: factory.talos.dev/installer/1470888f5d8755091c5d79199c1df242933a90d38c010d233ea3af5b4899982c
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: active-backup
          xmitHashPolicy: layer3+4
          miimon: 100
          updelay: 200
          downdelay: 200
          deviceSelectors:
            - hardwareAddr: "bc:24:11:a7:7e:af"
              physical: true
        dhcp: false
        addresses:
          - "192.168.20.10/24"
        routes:
          - network: "0.0.0.0/0"
            gateway: "192.168.20.1"
        mtu: 9000
        vlans:
          - # IOT
            vlanId: 70
            dhcp: false
            mtu: 9000
          - # VPN
            vlanId: 90
            dhcp: false
            mtu: 9000
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
            - siderolabs/intel-ucode
            - siderolabs/qemu-guest-agent
            - siderolabs/nfsrahead # NFS Performance
  - hostname: "matalos-c2"
    ipAddress: "192.168.20.11"
    installDiskSelector:
      model: "Samsung SSD 980 1TB"
    machineSpec:
      secureboot: false
    # Additional kernel commands needed for bonding
    # kernelArgs: bond=bond0:enp3s0,enp4s0:mode=802.3ad,xmit_hash_policy=layer3+4:9000 talos.network.interface.ignore=eno1 ip=192.168.20.11::192.168.20.1:255.255.255.0::bond0
    # kernelArge: -init_on_alloc -init_on_free -selinux apparmor=0 i915.enable_guc=3 init_on_alloc=0 init_on_free=0 intel_iommu=on iommu=pt mitigations=off security=none sysctl.kernel.kexec_load_disabled=1 talos.auditd.disabled=1
    talosImageURL: factory.talos.dev/installer/a5d0c037d27754228c7ba3fe522b8d2fb6e4082ce5511af612568ad2c2c9a826
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer3+4
          miimon: 100
          updelay: 200
          downdelay: 200
          deviceSelectors:
            - hardwareAddr: "02:76:c6:*"
              physical: true
        addresses:
          - "192.168.20.11/24"
        routes:
          - network: "0.0.0.0/0"
            gateway: "192.168.20.1"
        mtu: 9000
        vlans:
          - # IOT
            vlanId: 70
            dhcp: false
            mtu: 9000
          - # VPN
            vlanId: 90
            dhcp: false
            mtu: 9000
      - deviceSelector:
          hardwareAddr: "f8:75:a4:2c:46:e6"
        ignore: true
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
            - siderolabs/intel-ucode # Intel iGPU
            - siderolabs/i915 # Intel iGPU
            - siderolabs/mei # Intel iGPU
            - siderolabs/nfsrahead # NFS Performance
    nodeLabels:
      networking.home.arpa/vpn-capable: "true"
  - hostname: "matalos-c3"
    ipAddress: "192.168.20.12"
    installDiskSelector:
      model: "Samsung SSD 980 1TB"
    machineSpec:
      secureboot: false
    # Additional kernel commands needed for bonding
    # kernelArgs: bond=bond0:enp3s0,enp4s0:mode=802.3ad,xmit_hash_policy=layer3+4:9000 talos.network.interface.ignore=eno1 ip=192.168.20.12::192.168.20.1:255.255.255.0::bond0
    # kernelArge: -init_on_alloc -init_on_free -selinux apparmor=0 i915.enable_guc=3 init_on_alloc=0 init_on_free=0 intel_iommu=on iommu=pt mitigations=off security=none sysctl.kernel.kexec_load_disabled=1 talos.auditd.disabled=1
    talosImageURL: factory.talos.dev/installer/51842a7a5300aa9a4827649bad81916c5a6aac19f4752d6856f6515c66a782a9
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        bond:
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer3+4
          miimon: 100
          updelay: 200
          downdelay: 200
          deviceSelectors:
            - hardwareAddr: "02:76:c6:*"
              physical: true
        addresses:
          - "192.168.20.12/24"
        routes:
          - network: "0.0.0.0/0"
            gateway: "192.168.20.1"
        mtu: 9000
        vlans:
          - # IOT
            vlanId: 70
            dhcp: false
            mtu: 9000
          - # VPN
            vlanId: 90
            dhcp: false
            mtu: 9000
      - deviceSelector:
          hardwareAddr: "98:fa:9b:92:ef:43"
        ignore: true
    schematic:
      customization:
        systemExtensions:
          officialExtensions:
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
            - siderolabs/intel-ucode # Intel iGPU
            - siderolabs/i915 # Intel iGPU
            - siderolabs/mei # Intel iGPU
            - siderolabs/nfsrahead # NFS Performance
    nodeLabels:
      networking.home.arpa/vpn-capable: "true"

# Global patches
patches:
  - "@./patches/global/machine-features.yaml"
  - "@./patches/global/machine-files.yaml"
  - "@./patches/global/machine-kubelet.yaml"
  - "@./patches/global/machine-network.yaml"
  - "@./patches/global/machine-sysctls.yaml"
  - "@./patches/global/machine-time.yaml"
  - "@./patches/manifests/uservolumes.yaml"
  - "@./patches/manifests/watchdogtimerconfig.yaml"

# Controller patches
controlPlane:
  patches:
    - "@./patches/controller/cluster.yaml"
  kernelModules:
    - name: nvme_tcp
    - name: vfio_pci
    - name: uio_pci_generic
